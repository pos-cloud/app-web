<section>
  <div class="row header-transaction">
    <div class="col-md-12">
      <div class="row">
        <div class="col-md-2" *ngIf="transaction.table">
          <b>Mesa:</b> {{transaction.table.description}}
        </div>
        <div class="col-md-2" *ngIf="transaction.employeeClosing">
          <b>Empleado:</b> {{transaction.employeeClosing.name}}
        </div>
        <div class="col-md-3">
          <b>Cliente: </b>
          <span *ngIf="!transaction.company">Consumidor final</span>
          <span *ngIf="transaction.company">{{transaction.company.name}}</span>
        </div>
        <div class="col-md-2">
          <b>Apertura: </b>{{transaction.startDate | dateFormat:'HH:mm'}}
        </div>
        <div class="col-md-2 offset-md-1" *ngIf="posType==='resto'">
          <a class="btn" (click)="openModal('change-employee')">
            <i class="fa fa-exchange"></i> Cambiar Empleado</a>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="center-content" *ngIf="alertMessage !== ''">
        <ngb-alert [type]="alertConfig.type" [dismissible]="alertConfig.dismissible" (close)="alertMessage=''">
          {{alertMessage}}
        </ngb-alert>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 table-container">
      <div class="articles-container table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Cant</th>
              <th>Description</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let movementOfArticle of movementsOfArticles" (click)="editItem(movementOfArticle)">
              <td>{{movementOfArticle.amount}}</td>
              <td>{{movementOfArticle.description}}
                <strong *ngIf="movementOfArticle.notes">
                  <br> {{movementOfArticle.notes}}
                </strong>
              </td>
              <td>{{movementOfArticle.salePrice | currency:'USD':'1.2-2'}}</td>
              <td align=" left " width="20 ">
                <!-- <button type="button " class="btn btn-danger btn-sm " (click)="deleteMovementOfArticle(movementOfArticle._id) -->
                <!-- "><i class="fa fa-trash-o "></i></button> -->
              </td>
            </tr>
            <tr align="center " *ngIf="areMovementsOfArticlesEmpty ">
              <td colspan="10 ">Todavía no se cargaron productos al pedido</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="row">
        <table class="table table-hover">
          <tbody>
            <tr>
              <td align="right">
                <h5>
                  <b>Subtotal</b>
                </h5>
              </td>
              <td align="right">
                <h5>
                  <b>{{(transaction.totalPrice+transaction.discount) | currency:'USD':'1.2-2'}}</b>
                </h5>
              </td>
            </tr>
            <tr>
              <td align="right">
                <strong>Descuento</strong>
              </td>
              <td align="right">
                <strong>-{{transaction.discount | currency:'USD':'1.2-2'}}</strong>
              </td>
            </tr>
            <tr>
              <td align="right">
                <h3>
                  <b>TOTAL</b>
                </h3>
              </td>
              <td align="right">
                <h3>
                  <b>{{transaction.totalPrice | currency:'USD':'1.2-2'}}</b>
                </h3>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="row" *ngIf="posType==='resto'">
        <div class="col-md-6 btn-action btn-large center-content" (click)="setPrintBill()">
          Cuenta
        </div>
        <div class="col-md-6 btn-action btn-large center-content" (click)="openModal('charge')">
          Cobrar
        </div>
      </div>
      <div class="row" *ngIf="posType!=='resto'">
        <div class="col-md-12 btn-action btn-large center-content" (click)="openModal('charge')">
          Cobrar
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 btn-action btn-large center-content" (click)="openModal('add_client')">
          Cliente
        </div>
        <div class="col-md-4 btn-action btn-large center-content" (click)="openModal('apply_discount')">
          Descuento
        </div>
        <div class="col-md-4 btn-action btn-large center-content" (click)="openModal('cancel_transaction')">
          Cancelar
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="row filterArticle">
        <div class="col-md-12">
          <input type="text" class="form-control" [(ngModel)]="filterArticle" placeholder="Filtrar productos" (ngModelChange)="changeVisibilityArticle()" [focus]="focusEvent">
        </div>
      </div>
      <div class="row filterArticle">
        <div class="col-md-8">
          <nav class="breadcrumb">
            <span class="breadcrumb-item" [ngClass]="{'active':'areCategoriesVisible'}" (click)="showCategories()">Rubros</span>
            <span class="breadcrumb-item active" *ngIf="areArticlesVisible">Productos</span>
          </nav>
        </div>
        <div class="col-md-3 btn-action btn-large center-content" (click)="addItem()">
          Agregar Producto
        </div>
        <div class="col-md-1 btn-action btn-large center-content" (click)="close()">
          Cerrar
        </div>
      </div>
      <div [ngClass]="{'row table-responsive img-container':areArticlesVisible}">
        <div class="col-md-12">
          <app-list-articles (eventAddItem)="addItem($event)" [areArticlesVisible]="areArticlesVisible" [filterArticle]="filterArticle"
            [filterCategorySelected]="categorySelected"></app-list-articles>
        </div>
      </div>
      <div [ngClass]="{'row table-responsive img-container':areCategoriesVisible}">
        <div class="col-md-12">
          <app-list-categories (eventSelectCategory)="showArticlesOfCategory($event)" [areCategoriesVisible]="areCategoriesVisible"></app-list-categories>
        </div>
      </div>
    </div>
  </div>
</section>

<!--MODAL CANTIDAD-->
<ng-template #content let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Cantidad</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('close_click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form [formGroup]="amountOfItemForm" #formConfirmCant="ngForm" (ngSubmit)="c('edit_item')" autocomplete="off">
    <div class="modal-body container-fluid">
      <div class="row" *ngIf="isNewItem">
        <div class="form-group col-md-12">
          <label for="description" class="control-label">Descripción:</label>
          <div class="input-group">
            <input type="text" class="form-control" formControlName="description" name="description" id="description" />
          </div>
          <div *ngIf="formErrors.description" class="alert alert-danger">
            {{ formErrors.description }}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-12">
          <label for="amount" class="control-label">Ingrese la Cantidad:</label>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-10">
          <div class="input-group">
            <input type="number" class="form-control" formControlName="amount" name="amount" />
          </div>
          <div *ngIf="formErrors.amount" class="alert alert-danger">
            {{ formErrors.amount }}
          </div>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-danger" (click)="subtractAmount()">-</button>
          <button type="button" class="btn btn-success" (click)="addAmount()">+</button>
        </div>
      </div>
      <div class="row" *ngIf="isNewItem">
        <div class="form-group col-md-12">
          <label for="salePrice" class="control-label">Precio de Venta:</label>
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input type="number" class="form-control" formControlName="salePrice" name="salePrice" id="salePrice" step="0.01" />
          </div>
          <div *ngIf="formErrors.salePrice" class="alert alert-danger">
            {{ formErrors.salePrice }}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-12">
          <label for="notes" class="control-label">Notas:</label>
          <div class="input-group">
            <textarea type="text" class="form-control" formControlName="notes" name="notes" id="notes" rows="2"></textarea>
          </div>
          <div *ngIf="formErrors.notes" class="alert alert-danger">
            {{ formErrors.notes }}
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="c('cancel')">Cancelar</button>
      <button type="button" class="btn btn-danger" *ngIf="!isNewItem" (click)="c('delete_item')">Eliminar</button>
      <button type="submit" class="btn btn-primary" [disabled]="!amountOfItemForm.valid || loading">
        <i class="fa" [ngClass]="{'fa-save':!loading, 'fa-spinner fa-spin':loading}"></i>
        <span *ngIf="!loading">Aceptar</span>
        <span *ngIf="loading">Espere por favor</span>
      </button>
    </div>
  </form>
</ng-template>

<!--MODAL DESCUENTO-->
<ng-template #contentDiscount let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Descuento</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('close_click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <form [formGroup]="discountForm" #formDiscount="ngForm" (ngSubmit)="c('apply_discount')" autocomplete="off">
    <div class="modal-body container-fluid">
      <div class="row">
        <div class="form-group col-md-12">
          <label for="totalPrice" class="control-label">Monto de la transacción:</label>
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input type="number" class="form-control" name="totalPrice" min="0" step="0.01" [value]="this.transaction.totalPrice" readonly/>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-12">
          <label for="percentage" class="control-label">Percentageaje de descuento:</label>
          <div class="input-group">
            <span class="input-group-addon">%</span>
            <input type="number" class="form-control" formControlName="percentage" name="percentage" step="0.01" (blur)="updateDiscounts('percentage')"
              autofocus/>
          </div>
          <div *ngIf="formErrors.percentage" class="alert alert-danger">
            {{ formErrors.percentage }}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-12">
          <label for="amount" class="control-label">Monto de descuento:</label>
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input type="number" class="form-control" formControlName="amount" name="amount" min="0" step="0.01" (blur)="updateDiscounts('amount')"
            />
          </div>
          <div *ngIf="formErrors.amount" class="alert alert-danger">
            {{ formErrors.amount }}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="form-group col-md-12">
          <label for="transactionAmount" class="control-label">Monto de la transacción con descuento:</label>
          <div class="input-group">
            <span class="input-group-addon">$</span>
            <input type="number" class="form-control" formControlName="transactionAmount" name="transactionAmount" step="0.01" readonly/>
          </div>
          <div *ngIf="formErrors.transactionAmount" class="alert alert-danger">
            {{ formErrors.transactionAmount }}
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="c('cancel')">Cancelar</button>
      <button type="submit" class="btn btn-primary" [disabled]="!discountForm.valid || loading">
        <i class="fa" [ngClass]="{'fa-save':!loading, 'fa-spinner fa-spin':loading}"></i>
        <span *ngIf="!loading">Aceptar</span>
        <span *ngIf="loading">Espere por favor</span>
      </button>
    </div>
  </form>
</ng-template>

<!--MODAL ANULAR-->
<ng-template #contentCancelOrder let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Cancelar Pedido</h4>
    <button type="button" class="close" aria-label="Close" (click)="c(close_click)">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-md-12">
        <div class="center-content" *ngIf="alertMessage !== ''">
          <ngb-alert [type]="alertConfig.type" [dismissible]="alertConfig.dismissible" (close)="alertMessage=''">
            {{alertMessage}}
          </ngb-alert>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <p>¿Está seguro de anular el pedido?</p>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="c('cancel')">Cancelar</button>
    <button type="submit" class="btn btn-primary" (click)="c('cancel_transaction')">Aceptar</button>
  </div>
</ng-template>

<!--MODAL IMPRESORA-->
<ng-template #contentPrinters let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Impresoras</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('close_click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="row">
          <ul class="list-group">
            <li class="list-group-item center-content" *ngFor="let printer of printersAux" (click)="c(printer)">{{printer.name}}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="c('cancel')">Cancelar</button>
  </div>
</ng-template>

<!--MODAL ERROR IMPRESORA-->
<ng-template #contentMessage let-c="close" let-d="dismiss">
  <div class="modal-header">
    <h4 class="modal-title">Error de conexión</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('close_click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body container-fluid">
    <div class="row">
      <div class="col-md-12">
        Ha ocurrido un error de conexión con la impresora.
        <br> ¿Desea continuar?
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="c('cancel')">Cancelar</button>
    <button type="submit" class="btn btn-primary" (click)="c('y')">
      <span>Sí</span>
    </button>
  </div>
</ng-template>