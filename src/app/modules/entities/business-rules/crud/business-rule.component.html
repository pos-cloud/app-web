<section class="container-fluid">
  <div class="card">
    <div class="card-header">
      <span style="color: #607d8b" *ngIf="operation === 'add'">{{ 'add-business-rule' | translate | capitalize }}</span>
      <span style="color: #607d8b" *ngIf="operation === 'update'"
        >{{ 'edit' | translate | capitalize }} {{ businessRule?.name ?? '' }}</span
      >
      <span style="color: #607d8b" *ngIf="operation === 'view' || operation === 'delete'">
        {{ businessRule?.name ?? '' }}</span
      >
      <div class="pull-right">
        <button type="button" class="btn" (click)="returnTo()">
          <i class="fa fa-arrow-left"></i>
          <span>{{ 'return' | translate | capitalize }}</span>
        </button>
        <button
          type="button"
          class="btn"
          [disabled]="loading"
          *ngIf="operation !== 'delete' && operation !== 'view'"
          (click)="handleBusinessRuleOperation()"
        >
          <i class="fa" [ngClass]="{ 'fa-save': !loading, 'fa-spinner fa-spin': loading }"></i>
          <span *ngIf="!loading"> {{ 'save' | translate | capitalize }}</span>
          <span *ngIf="loading"> {{ 'loading' | translate | capitalize }}</span>
        </button>
        <button
          type="button"
          class="btn btn-danger active"
          *ngIf="operation === 'delete'"
          [disabled]="loading"
          (click)="deleteBusinessRule()"
        >
          <i class="fa" [ngClass]="{ 'fa-trash': !loading, 'fa-spinner fa-spin': loading }"></i>
          <span *ngIf="!loading"> {{ 'delete' | translate | capitalize }}</span>
          <span *ngIf="loading"> {{ 'loading' | translate | capitalize }}</span>
        </button>
      </div>
    </div>
    <app-progressbar [loading]="loading"></app-progressbar>
    <div class="card-body scroll">
      <form [formGroup]="businessRuleForm" autocomplete="off" *ngIf="!loading">
        <!-- Datos principales -->
        <div class="row">
          <label class="form-group col-md-12">
            <b>{{ 'mainData' | translate | capitalize }}</b>
          </label>
        </div>

        <!-- Primera fila: Código y Nombre -->
        <div class="row">
          <div class="form-group col-md-3">
            <label for="code" class="control-label">{{ 'code' | translate | capitalize }}:</label>
            <input
              type="text"
              class="form-control"
              formControlName="code"
              id="code"
              [readonly]="operation === 'view' || operation === 'delete'"
              [ngClass]="{
                'is-invalid': businessRuleForm.get('code')?.touched && businessRuleForm.get('code')?.invalid
              }"
            />
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('code')?.touched && businessRuleForm.get('code')?.hasError('required')"
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('code')?.touched && businessRuleForm.get('code')?.hasError('pattern')"
            >
              Solo se permiten letras y números
            </div>
          </div>
          <div class="form-group col-md-3">
            <label for="name" class="control-label">{{ 'name' | translate | capitalize }}:</label>
            <input
              type="text"
              class="form-control"
              formControlName="name"
              id="name"
              [focus]="focusEvent"
              [readonly]="operation === 'view' || operation === 'delete'"
              [ngClass]="{
                'is-invalid': businessRuleForm.get('name')?.touched && businessRuleForm.get('name')?.invalid
              }"
            />
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('name')?.touched && businessRuleForm.get('name')?.hasError('required')"
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
          </div>
          <div class="form-group col-md-3">
            <label for="active" class="control-label">{{ 'active' | translate | capitalize }}:</label>
            <select
              class="form-control"
              formControlName="active"
              id="active"
              [disabled]="operation === 'view' || operation === 'delete'"
            >
              <option [ngValue]="true">{{ 'yes' | translate | capitalize }}</option>
              <option [ngValue]="false">{{ 'no' | translate | capitalize }}</option>
            </select>
          </div>
          <div class="form-group col-md-3">
            <label for="includeInApplyAll" class="control-label">Incluir en "Aplicar Todas":</label>
            <select
              class="form-control"
              formControlName="includeInApplyAll"
              id="includeInApplyAll"
              [disabled]="operation === 'view' || operation === 'delete'"
            >
              <option [ngValue]="true">Sí</option>
              <option [ngValue]="false">No</option>
            </select>
            <small class="form-text text-muted">
              Indica si esta regla se aplicará cuando se presione "Aplicar Todas las Reglas"
            </small>
          </div>
        </div>

        <!-- Segunda fila: Fecha inicio, fecha fin, stock actual y días -->
        <div class="row">
          <div class="form-group col-md-3">
            <label for="startDate" class="control-label">{{ 'startDate' | translate | capitalize }}:</label>
            <input
              type="date"
              class="form-control"
              formControlName="startDate"
              id="startDate"
              [readonly]="operation === 'view' || operation === 'delete'"
            />
          </div>
          <div class="form-group col-md-3">
            <label for="endDate" class="control-label">{{ 'endDate' | translate | capitalize }}:</label>
            <input
              type="date"
              class="form-control"
              formControlName="endDate"
              id="endDate"
              [readonly]="operation === 'view' || operation === 'delete'"
            />
          </div>
          <div class="form-group col-md-3">
            <label for="totalStock" class="control-label">{{ 'totalStock' | translate | capitalize }}:</label>
            <input
              type="number"
              class="form-control"
              formControlName="totalStock"
              id="totalStock"
              [readonly]="operation === 'view' || operation === 'delete'"
              [ngClass]="{
                'is-invalid': businessRuleForm.get('totalStock')?.invalid && businessRuleForm.get('totalStock')?.touched
              }"
            />
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('totalStock')?.invalid && businessRuleForm.get('totalStock')?.touched"
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
          </div>
          <div class="form-group col-md-3">
            <label for="days" class="control-label">{{ 'days' | translate | capitalize }}:</label>
            <select
              id="days"
              class="form-control"
              formControlName="days"
              multiple
              [disabled]="operation === 'view' || operation === 'delete'"
            >
              <option *ngFor="let day of days" [value]="day._id">
                {{ day.name }}
              </option>
            </select>
          </div>
        </div>

        <hr />
        <div class="row">
          <label class="form-group col-md-12">
            <b>{{ 'discount' | translate | capitalize }}</b>
          </label>
        </div>
        <div class="row">
          <div class="form-group col-md-4">
            <label for="discountType" class="control-label">{{ 'discountType' | translate | capitalize }}:</label>
            <select
              class="form-control"
              formControlName="discountType"
              id="discountType"
              [disabled]="operation === 'view' || operation === 'delete'"
              [ngClass]="{
                'is-invalid':
                  businessRuleForm.get('discountType')?.invalid && businessRuleForm.get('discountType')?.touched
              }"
            >
              <option value="percentage">{{ 'percentage' | translate | capitalize }}</option>
              <option value="amount">Monto</option>
            </select>
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('discountType')?.invalid && businessRuleForm.get('discountType')?.touched"
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
          </div>
          <div class="form-group col-md-4">
            <label for="discountValue" class="control-label">{{ 'discountValue' | translate | capitalize }}:</label>
            <input
              type="number"
              class="form-control"
              formControlName="discountValue"
              id="discountValue"
              [readonly]="operation === 'view' || operation === 'delete'"
              [ngClass]="{
                'is-invalid':
                  businessRuleForm.get('discountValue')?.invalid && businessRuleForm.get('discountValue')?.touched
              }"
            />
            <div
              class="invalid-feedback"
              *ngIf="businessRuleForm.get('discountValue')?.invalid && businessRuleForm.get('discountValue')?.touched"
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
          </div>
          <div class="form-group col-md-4">
            <label for="articleDiscount" class="control-label">{{ 'articleDiscount' | translate | capitalize }}:</label>
            <app-typeahead-dropdown
              [control]="businessRuleForm.get('articleDiscount')"
              [data]="articles"
              [keyField]="'_id'"
              [displayField]="'description'"
            ></app-typeahead-dropdown>
            <div
              class="invalid-feedback"
              *ngIf="
                businessRuleForm.get('articleDiscount')?.invalid && businessRuleForm.get('articleDiscount')?.touched
              "
            >
              {{ 'fieldRequired' | translate | capitalize }}
            </div>
          </div>
        </div>

        <hr />
        <div class="row">
          <label class="form-group col-md-12">
            <b>{{ 'articles' | translate | capitalize }}</b>
          </label>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="thead-light">
                  <tr>
                    <th style="width: 70%">{{ 'article' | translate | capitalize }}</th>
                    <th style="width: 20%">{{ 'quantity' | translate | capitalize }}</th>
                    <th *ngIf="operation !== 'view' && operation !== 'delete'" style="width: 10%">
                      <button type="button" class="btn btn-success btn-sm" (click)="addArticle()">
                        <i class="fa fa-plus"></i>
                      </button>
                    </th>
                  </tr>
                </thead>
                <tbody formArrayName="articles">
                  <tr *ngFor="let article of articlesArray.controls; let i = index" [formGroupName]="i">
                    <td>
                      <div class="typeahead-wrapper">
                        <app-typeahead-dropdown
                          [control]="article.get('article')"
                          [data]="articles"
                          [keyField]="'_id'"
                          [displayField]="'description'"
                        ></app-typeahead-dropdown>
                      </div>
                    </td>
                    <td>
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="quantity"
                        [readonly]="operation === 'view' || operation === 'delete'"
                        [ngClass]="{
                          'is-invalid': article.get('quantity')?.invalid && article.get('quantity')?.touched
                        }"
                      />
                    </td>
                    <td *ngIf="operation !== 'view' && operation !== 'delete'">
                      <button type="button" class="btn btn-danger btn-sm" (click)="removeArticle(i)">
                        <i class="fa fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <hr />
        <div class="row">
          <label class="form-group col-md-12">
            <b>Grupos de artículos</b>
          </label>
          <div class="col-md-12">
            <small class="form-text text-muted">
              La promo aplica si se cumple la cantidad con <em>cualquiera</em> de los artículos del grupo (ej: 4 chocolates sin importar el sabor).
            </small>
          </div>
        </div>
        <div class="row" formArrayName="articleGroups">
          <ng-container *ngIf="articleGroupsArray.length === 0 && operation !== 'view' && operation !== 'delete'">
            <div class="col-md-12">
              <div class="table-responsive">
                <table class="table table-bordered table-hover">
                  <tbody>
                    <tr>
                      <td class="text-muted text-center py-3">
                        Aún no hay grupos. Agregá uno para definir artículos alternativos (ej: distintos sabores que suman a la misma cantidad).
                        <div class="mt-2">
                          <button type="button" class="btn btn-outline-primary btn-sm" (click)="addArticleGroup()">
                            <i class="fa fa-plus"></i> Agregar grupo
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-container>
          <div class="col-md-12" *ngFor="let group of articleGroupsArray.controls; let gIdx = index" [formGroupName]="gIdx">
            <div class="d-flex align-items-center flex-wrap mb-2">
              <span class="font-weight-bold mr-2">Grupo {{ gIdx + 1 }}</span>
              <label class="mb-0 mr-1">{{ 'quantity' | translate | capitalize }}:</label>
              <input
                type="number"
                class="form-control form-control-sm mr-2 group-quantity-input"
                [formControl]="articleGroupsArray.at(gIdx).get('quantity')"
                min="1"
                [readonly]="operation === 'view' || operation === 'delete'"
                [ngClass]="{
                  'is-invalid':
                    articleGroupsArray.at(gIdx).get('quantity')?.invalid &&
                    articleGroupsArray.at(gIdx).get('quantity')?.touched
                }"
              />
              <div
                class="invalid-feedback d-block mb-0 mr-2"
                *ngIf="
                  articleGroupsArray.at(gIdx).get('quantity')?.invalid &&
                  articleGroupsArray.at(gIdx).get('quantity')?.touched
                "
              >
                Mínimo 1
              </div>
              <button
                *ngIf="operation !== 'view' && operation !== 'delete'"
                type="button"
                class="btn btn-danger btn-sm"
                (click)="removeArticleGroup(gIdx)"
              >
                <i class="fa fa-trash"></i> Quitar grupo
              </button>
            </div>
            <div class="table-responsive mb-3">
              <table class="table table-bordered table-hover">
                <thead class="thead-light">
                  <tr>
                    <th style="width: 90%">{{ 'article' | translate | capitalize }} (cualquiera del grupo)</th>
                    <th *ngIf="operation !== 'view' && operation !== 'delete'" style="width: 10%">
                      <button type="button" class="btn btn-success btn-sm" (click)="addArticleToGroup(gIdx)" title="Agregar artículo a este grupo">
                        <i class="fa fa-plus"></i>
                      </button>
                    </th>
                  </tr>
                </thead>
                <tbody formArrayName="articles">
                  <tr *ngFor="let art of getGroupArticlesArray(gIdx).controls; let aIdx = index" [formControlName]="aIdx">
                    <td>
                      <div class="typeahead-wrapper">
                        <app-typeahead-dropdown
                          [control]="getGroupArticlesArray(gIdx).at(aIdx)"
                          [data]="articles"
                          [keyField]="'_id'"
                          [displayField]="'description'"
                          [showInvalidOnlyAfterSubmit]="true"
                          [formSubmitted]="formSubmitted"
                        ></app-typeahead-dropdown>
                      </div>
                    </td>
                    <td *ngIf="operation !== 'view' && operation !== 'delete'">
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        (click)="removeArticleFromGroup(gIdx, aIdx)"
                        [disabled]="getGroupArticlesArray(gIdx).length <= 1"
                      >
                        <i class="fa fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="col-md-12" *ngIf="articleGroupsArray.length > 0 && operation !== 'view' && operation !== 'delete'">
            <button type="button" class="btn btn-outline-primary btn-sm mb-3" (click)="addArticleGroup()">
              <i class="fa fa-plus"></i> Agregar grupo
            </button>
          </div>
        </div>

        <style>
          .group-quantity-input {
            width: 5rem;
          }
          /* Estilos para solucionar el problema del dropdown en la tabla */
          .typeahead-wrapper {
            position: relative;
          }

          .typeahead-wrapper .dropdown-menu {
            z-index: 9999 !important;
            position: absolute !important;
          }

          .table-responsive {
            overflow: visible !important;
          }

          .table {
            overflow: visible !important;
          }

          .table tbody {
            overflow: visible !important;
          }

          .table td {
            overflow: visible !important;
          }
        </style>

        <hr />
        <div class="row">
          <label class="form-group col-md-12">
            <b>{{ 'audit' | translate | capitalize }}</b>
          </label>
        </div>
        <div class="row">
          <div class="form-group col-md-12">
            <div class="row">
              <div class="form-group col-md-6">
                <label class="control-label">
                  {{ 'creationUser.name' | translate | capitalize }}:
                  <b>{{ businessRule?.creationUser?.name ?? '' }}</b>
                </label>
              </div>
              <div class="form-group col-md-6">
                <label class="control-label">
                  {{ 'theDay' | translate | capitalize }}:
                  <b>{{ businessRule?.creationDate ?? null | dateFormat : 'DD/MM/YYYY HH:mm:ss' }}</b>
                </label>
              </div>
            </div>
            <div class="row">
              <div class="form-group col-md-6">
                <label class="control-label">
                  {{ 'updateUser.name' | translate | capitalize }}:
                  <b>{{ businessRule?.updateUser?.name ?? '' }}</b>
                </label>
              </div>
              <div class="form-group col-md-6">
                <label class="control-label">
                  {{ 'theDay' | translate | capitalize }}:
                  <b>{{ businessRule?.updateDate ?? null | dateFormat : 'DD/MM/YYYY HH:mm:ss' }}</b>
                </label>
              </div>
            </div>
            <div class="row">
              <div class="form-group col-md-6">
                <label class="control-label">
                  {{ 'id' | translate | capitalize }}:
                  <b>{{ businessRule?._id ?? '' }}</b>
                </label>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
